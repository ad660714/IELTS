<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Snap2HTML - 雅思真题目录</title>
    <!-- 保持原始样式和依赖库 -->
    <style type="text/css">
        body { margin: 0; padding: 0; background-color: #f4f4f4; font-family: Arial, sans-serif; }
        #wrapper { margin: 0; padding: 0; width: 100%; }
        #list_files { margin: 0; padding: 0 20px 20px 20px; float: right; width: calc(100% - 300px); }
        #tree_view { width: 260px; float: left; margin: 0; padding: 20px 0 20px 20px; }
        /* ... 其他样式保持不变 ... */
    </style>
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery.tablesorter/2.31.3/js/jquery.tablesorter.min.js"></script>
    <script type="text/javascript">
        var sourceRoot = "D:/雅思真题目录/";
        var dirs = [];
        var D = { p: function(a) { dirs.push(a); } };

        // 更新 dirs 数据，包含 PDF 和音频文件
        D.p(["D:/雅思真题目录/*0*1697694571",
             "IELTS16_成绩版.pdf*1234567*1697694571",
             "index.html*1024*1697694571",
             "剑桥11.pdf*1234567*1697694571",
             "剑桥12至15.pdf*1234567*1697694571",
             "剑桥16至18_答案版.pdf*1234567*1697694571",
             "剑桥真题13.pdf*1234567*1697694571",
             "剑桥真题10.pdf*1234567*1697694571",
             0,""]);
        D.p(["D:/雅思真题目录/雅思真题音频/*0*1697694571", 0,""]);
        D.p(["D:/雅思真题目录/雅思真题音频/新真17至18/*0*1697694571",
             "C 18 section4 part1.mp3*7086393*1686480058",
             "C 18 section4 part2.mp3*6978142*1686480072",
             "C 18 section4 part3.mp3*6689750*1686480088",
             "C 18 section4 part4.mp3*7959092*1686480104",
             28713377,""]);
        D.p(["D:/雅思真题目录/新真17至18/*0*1697694571", 0,""]);

        // 使用相对路径
        var linkRoot = "";
        var linkFiles = true;
        var onlyLinkExtensions = [];

        $(document).ready(function(){
            // 添加调试信息
            console.log("dirs 数据：", dirs);
            console.log("jQuery 已加载：", typeof $ !== "undefined");

            // 新增函数：根据试卷文件名查找相关音频文件
            function findRelatedAudioFiles(pdfName) {
                var audioFiles = [];
                var pdfBaseName = pdfName.toLowerCase().replace(/\.pdf$/, '');

                // 匹配逻辑：根据 PDF 文件名匹配音频文件
                var audioPrefix = null;
                if (pdfBaseName.includes("16至18")) {
                    audioPrefix = "C 18";
                } else if (pdfBaseName.includes("11")) {
                    audioPrefix = "C 11";
                } else if (pdfBaseName.includes("12至15")) {
                    audioPrefix = "C 12";
                } else if (pdfBaseName.includes("13")) {
                    audioPrefix = "C 13";
                } else if (pdfBaseName.includes("10")) {
                    audioPrefix = "C 10";
                } else if (pdfBaseName.includes("16")) {
                    audioPrefix = "C 16";
                }

                if (audioPrefix) {
                    for (var i = 0; i < dirs.length; i++) {
                        for (var j = 1; j < dirs[i].length - 2; j++) {
                            var fileInfo = dirs[i][j].split("*");
                            var fileName = fileInfo[0];
                            if (fileName.endsWith(".mp3") && fileName.includes(audioPrefix)) {
                                audioFiles.push({
                                    name: fileName,
                                    path: getDirNameAndPath(i).replace(sourceRoot, "") + "/" + fileName
                                });
                            }
                        }
                    }
                }
                console.log("查找音频文件 for", pdfName, "结果：", audioFiles);
                return audioFiles;
            }

            // 新增函数：生成试卷和音频的整合页面
            function openPaperWithAudio(pdfPath, pdfName) {
                var audioFiles = findRelatedAudioFiles(pdfName);
                var newWindow = window.open("", "_blank");
                if (!newWindow) {
                    alert("无法打开新窗口，请检查浏览器是否阻止了弹出窗口！");
                    return;
                }
                var htmlContent = `
                    <!DOCTYPE html>
                    <html lang="zh-CN">
                    <head>
                        <meta charset="UTF-8">
                        <title>${pdfName}</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 20px; background-color: #f4f4f4; }
                            .container { display: flex; justify-content: space-between; max-width: 1200px; margin: 0 auto; }
                            .audio-section { width: 35%; background-color: #fff; padding: 15px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
                            .paper-section { width: 60%; background-color: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); }
                            .audio-section h2, .paper-section h2 { margin-top: 0; color: #333; font-size: 18px; }
                            .audio-section p { margin: 5px 0; font-size: 14px; }
                            audio { width: 100%; height: 30px; margin-bottom: 8px; }
                            iframe { width: 100%; height: 600px; border: none; }
                        </style>
                    </head>
                    <body>
                        <div class="container">
                            <div class="audio-section">
                                <h2>相关听力音频</h2>
                `;

                if (audioFiles.length === 0) {
                    htmlContent += `<p>未找到相关音频文件。</p>`;
                } else {
                    audioFiles.forEach(function(audio) {
                        var audioUrl = audio.path.replace(/\\/g, "/").replace(/\/\//g, "/");
                        console.log("音频文件路径：", audioUrl);
                        htmlContent += `
                            <p>${audio.name}</p>
                            <audio controls>
                                <source src="${audioUrl}" type="audio/mpeg">
                                您的浏览器不支持音频播放。
                            </audio>
                        `;
                    });
                }

                htmlContent += `
                            </div>
                            <div class="paper-section">
                                <h2>${pdfName}</h2>
                                <iframe src="${pdfPath}"></iframe>
                            </div>
                        </div>
                    </body>
                    </html>
                `;

                newWindow.document.write(htmlContent);
                newWindow.document.close();
            }

            // 修改 ShowFolder 函数，拦截试卷链接点击
            function ShowFolder(FolderID) {
                console.log("显示文件夹：", FolderID);
                var table_html = "";
                var showParentFolderClass = "";
                if (FolderID != 0) {
                    showParentFolderClass = " has-parent-folder";
                    table_html += "<span id='parent_folder' class='file_folder'><a href=\"#\" class=\"folder_link\" id=\"" + parent_folders[FolderID] + "\"> [..]</a></span>\n";
                    table_html += "<div id='parent_folder_border'></div>";
                }
                table_html += "<table id='files' class='tablesorter" + showParentFolderClass + "'><thead><th>Name</th><th>Size</th><th>Modified</th></tr></thead><tbody>\n";

                currentView = [];
                var countFiles = 0;
                var countDirs = 0;
                var subdirTotSizes = 0;

                // 文件夹
                var subdirs = getSubdirs(SelectedFolderID);
                if (subdirs != "") {
                    for (var c = 0; c < subdirs.length; c++) {
                        countDirs++;
                        var sTmp = dirs[subdirs[c]][0].split("*");
                        var name = sTmp[0].substring(sTmp[0].lastIndexOf("/") + 1);
                        var dirSize = getDirTreeSize(subdirs[c]);
                        subdirTotSizes += dirSize;
                        var timestamp = timestampToDate(sTmp[2]);
                        table_html += 
                            "<tr>" + 
                                "<td><span class='file_folder'><a href=\"#\" class=\"folder_link\" id=\"" + subdirs[c] + "\"> " + name + "</a></span></td>" + 
                                "<td class='size' data-sort='" + dirSize + "'>" + bytesToSize(dirSize) + "</td>" + 
                                "<td class='date' data-sort='" + sTmp[2] + "'>" + timestamp + "</td>" + 
                            "</tr>\n";
                        currentView.push({"name": name, "path": currentViewPath, "type": "dir", "size": dirSize, "date": sTmp[2]});
                    }
                }

                // 文件
                for (var c = 1; c < dirs[SelectedFolderID].length - 2; c++) {
                    countFiles++;
                    var sTmp = dirs[SelectedFolderID][c].split("*");
                    var file_tmp = sTmp[0];
                    var dir_tmp = getDirNameAndPath(SelectedFolderID).replace(sourceRoot, "");
                    if (dir_tmp != "") dir_tmp += "/";
                    var filePath = dir_tmp + sTmp[0];
                    filePath = filePath.replace(/\\/g, "/").replace(/\/\//g, "/").replace(/#/g, "%23");

                    if (file_tmp.endsWith(".pdf")) {
                        table_html += 
                            "<tr>" + 
                                "<td><span class='file'><a href='#' class='paper_link' data-path='" + filePath + "' data-name='" + file_tmp + "'>" + file_tmp + "</a></span></td>" + 
                                "<td class='size' data-sort='" + sTmp[1] + "'>" + bytesToSize(sTmp[1]) + "</td>" + 
                                "<td class='date' data-sort='" + sTmp[2] + "'>" + timestamp + "</td>" + 
                            "</tr>\n";
                    } else {
                        if (linkFiles) {
                            var ext = file_tmp.split('.').pop();
                            if (onlyLinkExtensions.length === 0 || onlyLinkExtensions.indexOf(ext) !== -1) {
                                file_tmp = "<a target=\"_blank\" href=\"" + filePath + "\">" + sTmp[0] + "</a>";
                            }
                        }
                        table_html += 
                            "<tr>" + 
                                "<td><span class='file'>" + file_tmp + "</span></td>" + 
                                "<td class='size' data-sort='" + sTmp[1] + "'>" + bytesToSize(sTmp[1]) + "</td>" + 
                                "<td class='date' data-sort='" + sTmp[2] + "'>" + timestamp + "</td>" + 
                            "</tr>\n";
                    }
                    currentView.push({"name": sTmp[0], "path": currentViewPath, "type": "file", "size": sTmp[1], "date": sTmp[2]});
                }

                table_html += "</tbody></table>\n";

                document.getElementById("list_files").innerHTML = table_html;
                addFolderClickEventHandlers();
                $("#files").tablesorter({
                    sortInitialOrder: "desc",
                    headers: {
                        1: { sorter: 'datasort' },
                        2: { sorter: 'datasort' }
                    }
                });

                // 添加试卷链接点击事件
                $("body").delegate("a.paper_link", "click", function(e) {
                    e.preventDefault();
                    var pdfPath = $(this).data("path");
                    var pdfName = $(this).data("name");
                    console.log("打开试卷：", pdfName, "路径：", pdfPath);
                    openPaperWithAudio(pdfPath, pdfName);
                });
            }

            // ... 原始代码剩余部分保持不变 ...
        });
    </script>
</head>
<body>
    <div id="wrapper">
        <div id="tree_view"></div>
        <div id="list_files"></div>
    </div>
</body>
</html>
